<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuario - Bibliosfera</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .register-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        .logo-text {
            color: #007bff;
            font-weight: bold;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            border: none;
        }
        .username-preview {
            background-color: #e8f4fd;
            border-left: 4px solid #007bff;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .required::after {
            content: " *";
            color: #dc3545;
        }
        .api-field {
            background-color: #f8f9fa !important;
            cursor: not-allowed !important;
            user-select: none !important;
        }
        .api-field:hover {
            background-color: #f8f9fa !important;
        }
        .field-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 3px;
            margin-left: 5px;
        }
        .field-status-auto {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .field-status-manual {
            background-color: #fff3cd;
            color: #856404;
        }
        .dni-info-card {
            border: 1px solid #d1ecf1;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background-color: #f8fdfe;
        }
        .dni-loading {
            text-align: center;
            padding: 10px;
        }
        .dni-error {
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="register-container">
        <!-- Logo y título -->
        <div class="text-center mb-4">
            <h2 class="logo-text">
                <i class="bi bi-book-fill"></i> Bibliosfera
            </h2>
            <p class="text-secondary">Crear nueva cuenta de usuario</p>
        </div>

        <!-- Mensajes flash del servidor -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Formulario de registro -->
        <form id="registroForm" th:action="@{/registro/procesar}" method="post">
            
            <!-- Sección DNI (Obligatorio) -->
            <div class="mb-4">
                <h5 class="text-info mb-3">
                    <i class="bi bi-credit-card"></i> Consulta DNI
                </h5>
                
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="dni" class="form-label required">DNI</label>
                        <input type="text" id="dni" name="dni" class="form-control" 
                               maxlength="8" placeholder="8 dígitos" required
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        <div class="form-text">Ingresa tu DNI para autocompletar tus datos</div>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-primary w-100" onclick="consultarDNI()" id="btnConsultar">
                            <i class="bi bi-search"></i> Consultar
                        </button>
                    </div>
                </div>
                
                <!-- Loading indicator -->
                <div id="dniLoading" class="dni-loading" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Consultando...</span>
                    </div>
                    <span class="ms-2">Consultando datos en RENIEC...</span>
                </div>
                
                <!-- Información del DNI consultado -->
                <div id="dniInfoCard" class="dni-info-card" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong><i class="bi bi-person"></i> Nombres:</strong></p>
                            <p class="mb-1"><strong><i class="bi bi-person-badge"></i> Apellido Paterno:</strong></p>
                            <p class="mb-1"><strong><i class="bi bi-person-badge"></i> Apellido Materno:</strong></p>
                            <p class="mb-1"><strong><i class="bi bi-card-checklist"></i> DNI:</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1" id="dniNombres">-</p>
                            <p class="mb-1" id="dniApellidoPaterno">-</p>
                            <p class="mb-1" id="dniApellidoMaterno">-</p>
                            <p class="mb-1" id="dniNumero">-</p>
                        </div>
                    </div>
                    <hr class="my-2">
                    <p class="fw-bold mb-0">
                        <i class="bi bi-person-lines-fill"></i> Nombre completo:
                        <span class="text-primary" id="dniNombreCompleto"></span>
                    </p>
                </div>
                
                <!-- Error del DNI -->
                <div id="dniError" class="dni-error" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span id="dniErrorMessage"></span>
                </div>
            </div>

            <!-- Sección Datos Personales -->
            <div class="mb-4">
                <h5 class="text-secondary mb-3">
                    <i class="bi bi-person-circle"></i> Datos Personales
                </h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nombre" class="form-label required">
                            Nombre 
                            <span id="nombreStatus" class="field-status field-status-auto" style="display: none;">Desde DNI</span>
                        </label>
                        <input type="text" id="nombre" name="nombre" class="form-control" 
                               placeholder="Se autocompletará con tu DNI" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="apellido" class="form-label required">
                            Apellido 
                            <span id="apellidoStatus" class="field-status field-status-auto" style="display: none;">Desde DNI</span>
                        </label>
                        <input type="text" id="apellido" name="apellido" class="form-control" 
                               placeholder="Se autocompletará con tu DNI" required>
                    </div>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i>
                    Los campos <strong>Nombre</strong> y <strong>Apellido</strong> se llenarán automáticamente con los datos de tu DNI.
                </div>
                
                <!-- Vista previa del nombre de usuario -->
                <div id="nombreUsuarioPreview" class="username-preview" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    <strong>Tu nombre de usuario será:</strong> 
                    <span id="nombreUsuarioText" class="fw-bold text-primary"></span>
                </div>
            </div>

            <!-- Sección Credenciales -->
            <div class="mb-4">
                <h5 class="text-secondary mb-3">
                    <i class="bi bi-shield-lock"></i> Credenciales de Acceso
                </h5>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="password" class="form-label required">Contraseña</label>
                        <input type="password" id="password" name="password" class="form-control" 
                               placeholder="Mínimo 6 caracteres" minlength="6" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="confirmPassword" class="form-label required">Confirmar Contraseña</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" 
                               placeholder="Repite tu contraseña" required>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-success btn-lg" id="btnRegistrar" disabled>
                    <i class="bi bi-person-plus"></i> Crear Cuenta
                </button>
                <a th:href="@{/login}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> ¿Ya tienes cuenta? Inicia sesión
                </a>
            </div>
            
            <!-- Términos y condiciones -->
            <div class="mt-3 text-center">
                <small class="text-muted">
                    Al registrarte, aceptas nuestros 
                    <a href="#" class="text-decoration-none">Términos y Condiciones</a> 
                    y nuestra 
                    <a href="#" class="text-decoration-none">Política de Privacidad</a>
                </small>
            </div>
        </form>
    </div>
</div>

<script>
    // Variables globales
    let datosDeApi = false;
    
    // Mostrar mensaje de alerta temporal
    function showAlert(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insertar después del título
        const title = document.querySelector('.text-center.mb-4');
        title.parentNode.insertBefore(alertDiv, title.nextSibling);
        
        // Auto-eliminar después de 5 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Mostrar error de DNI
    function mostrarErrorDNI(mensaje) {
        console.error('Error DNI:', mensaje);
        ocultarDniInfoCard();
        const errorDiv = document.getElementById('dniError');
        const errorMessage = document.getElementById('dniErrorMessage');
        errorMessage.textContent = mensaje;
        errorDiv.style.display = 'block';
    }
    
    // Ocultar error de DNI
    function ocultarErrorDNI() {
        document.getElementById('dniError').style.display = 'none';
    }
    
    // Mostrar tarjeta de información del DNI
    function mostrarDniInfoCard(datos) {
        console.log('Mostrando datos DNI:', datos);
        const card = document.getElementById('dniInfoCard');
        const dniNombres = datos.nombres || '';
        const dniApellidoPaterno = datos.apellidoPaterno || '';
        const dniApellidoMaterno = datos.apellidoMaterno || '';
        
        document.getElementById('dniNombres').textContent = dniNombres;
        document.getElementById('dniApellidoPaterno').textContent = dniApellidoPaterno;
        document.getElementById('dniApellidoMaterno').textContent = dniApellidoMaterno;
        document.getElementById('dniNumero').textContent = document.getElementById('dni').value;
        
        const nombreCompleto = `${dniNombres} ${dniApellidoPaterno} ${dniApellidoMaterno}`.trim();
        document.getElementById('dniNombreCompleto').textContent = nombreCompleto;
        
        card.style.display = 'block';
        ocultarErrorDNI();
    }
    
    // Ocultar tarjeta de información del DNI
    function ocultarDniInfoCard() {
        document.getElementById('dniInfoCard').style.display = 'none';
    }
    
    // Actualizar estado de los campos
    function actualizarEstadoCampos() {
        const nombreField = document.getElementById('nombre');
        const apellidoField = document.getElementById('apellido');
        const nombreStatus = document.getElementById('nombreStatus');
        const apellidoStatus = document.getElementById('apellidoStatus');
        const btnRegistrar = document.getElementById('btnRegistrar');
        
        if (datosDeApi) {
            // Bloquear campos si vienen de API
            nombreField.classList.add('api-field');
            apellidoField.classList.add('api-field');
            nombreField.readOnly = true;
            apellidoField.readOnly = true;
            
            nombreStatus.style.display = 'inline';
            apellidoStatus.style.display = 'inline';
            
            // Habilitar botón de registro
            btnRegistrar.disabled = false;
            btnRegistrar.innerHTML = '<i class="bi bi-person-plus"></i> Crear Cuenta';
            
        } else {
            // Permitir edición manual
            nombreField.classList.remove('api-field');
            apellidoField.classList.remove('api-field');
            nombreField.readOnly = false;
            apellidoField.readOnly = false;
            
            nombreStatus.style.display = 'none';
            apellidoStatus.style.display = 'none';
            
            // Deshabilitar botón si no hay DNI válido
            btnRegistrar.disabled = true;
            btnRegistrar.innerHTML = '<i class="bi bi-lock"></i> Consulta tu DNI primero';
        }
    }
    
    // Actualizar vista previa del nombre de usuario
    function actualizarNombreUsuario() {
        const nombre = document.getElementById('nombre').value.trim();
        const apellido = document.getElementById('apellido').value.trim();
        const preview = document.getElementById('nombreUsuarioPreview');
        
        if (nombre && apellido) {
            // Tomar primer nombre y primer apellido
            const primerNombre = nombre.split(' ')[0];
            const primerApellido = apellido.split(' ')[0];
            
            // Capitalizar: primera letra mayúscula, resto minúscula
            const nombreCapitalizado = primerNombre.charAt(0).toUpperCase() + 
                                     primerNombre.slice(1).toLowerCase();
            const apellidoCapitalizado = primerApellido.charAt(0).toUpperCase() + 
                                       primerApellido.slice(1).toLowerCase();
            
            const nombreUsuario = nombreCapitalizado + ' ' + apellidoCapitalizado;
            
            // Mostrar preview
            document.getElementById('nombreUsuarioText').textContent = nombreUsuario;
            preview.style.display = 'block';
            
        } else {
            preview.style.display = 'none';
        }
    }
    
    // Consultar DNI - VERSIÓN DEBUG
    async function consultarDNI() {
        const dni = document.getElementById('dni').value.trim();
        const btn = document.getElementById('btnConsultar');
        
        console.log('=== INICIANDO CONSULTA DNI ===');
        console.log('DNI:', dni);
        
        // Validar DNI
        if (!dni || dni.length !== 8 || isNaN(dni)) {
            mostrarErrorDNI('DNI inválido. Debe tener exactamente 8 dígitos numéricos.');
            datosDeApi = false;
            actualizarEstadoCampos();
            return;
        }
        
        // Guardar estado original del botón
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Consultando...';
        btn.disabled = true;
        document.getElementById('dniLoading').style.display = 'block';
        ocultarDniInfoCard();
        ocultarErrorDNI();
        
        // Limpiar campos anteriores
        document.getElementById('nombre').value = '';
        document.getElementById('apellido').value = '';
        datosDeApi = false;
        actualizarEstadoCampos();
        actualizarNombreUsuario();
        
        try {
            console.log('Haciendo fetch a /registro/api/reniec/dni/' + dni);
            
            // Opción 1: Intentar con el endpoint de registro
            const response = await fetch(`/registro/api/reniec/dni/${dni}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // Leer la respuesta como texto primero para debug
            const responseText = await response.text();
            console.log('Response text:', responseText.substring(0, 200) + '...');
            
            // Intentar parsear como JSON
            let data;
            try {
                data = JSON.parse(responseText);
                console.log('JSON parseado:', data);
            } catch (jsonError) {
                console.error('Error parseando JSON:', jsonError);
                console.error('Respuesta completa:', responseText);
                
                // Si no es JSON, puede ser HTML de error
                if (responseText.includes('<!DOCTYPE')) {
                    throw new Error('El servidor devolvió HTML en lugar de JSON. Revisa el endpoint.');
                }
                throw new Error('Respuesta no válida del servidor');
            }
            
            if (data.success) {
                // Marcar que los datos vienen de API
                datosDeApi = true;
                
                // Autocompletar campos
                const nombres = data.nombres || '';
                const apellidoPaterno = data.apellidoPaterno || '';
                const apellidoMaterno = data.apellidoMaterno || '';
                
                document.getElementById('nombre').value = nombres;
                
                // Construir apellido completo
                let apellidoCompleto = '';
                if (apellidoPaterno && apellidoMaterno) {
                    apellidoCompleto = apellidoPaterno + ' ' + apellidoMaterno;
                } else if (apellidoPaterno) {
                    apellidoCompleto = apellidoPaterno;
                }
                document.getElementById('apellido').value = apellidoCompleto;
                
                // Mostrar información en tarjeta
                mostrarDniInfoCard(data);
                
                // Actualizar estado de campos
                actualizarEstadoCampos();
                
                // Actualizar preview
                actualizarNombreUsuario();
                
                showAlert('✓ Datos encontrados y autocompletados', 'success');
                
                console.log('Datos autocompletados correctamente');
                
                // Enfocar el campo de contraseña
                document.getElementById('password').focus();
                
            } else {
                const errorMsg = data.message || 'No se encontraron datos para este DNI';
                console.error('Error en respuesta:', errorMsg);
                mostrarErrorDNI(errorMsg);
                datosDeApi = false;
                actualizarEstadoCampos();
            }
            
        } catch (error) {
            console.error('Error completo en consulta DNI:', error);
            
            // Intentar con el endpoint alternativo si el principal falla
            try {
                console.log('Intentando con endpoint alternativo /api/consulta/dni/' + dni);
                const altResponse = await fetch(`/api/consulta/dni/${dni}`);
                if (altResponse.ok) {
                    const altData = await altResponse.json();
                    console.log('Datos del endpoint alternativo:', altData);
                    
                    if (altData && altData.nombres) {
                        // Usar datos del endpoint alternativo
                        datosDeApi = true;
                        document.getElementById('nombre').value = altData.nombres || '';
                        document.getElementById('apellido').value = 
                            (altData.apellidoPaterno || '') + ' ' + (altData.apellidoMaterno || '');
                        
                        mostrarDniInfoCard(altData);
                        actualizarEstadoCampos();
                        actualizarNombreUsuario();
                        showAlert('✓ Datos obtenidos del servicio alternativo', 'info');
                        return;
                    }
                }
            } catch (altError) {
                console.error('Endpoint alternativo también falló:', altError);
            }
            
            // Si todo falla, mostrar error
            mostrarErrorDNI('Error al consultar el DNI: ' + error.message);
            datosDeApi = false;
            actualizarEstadoCampos();
        } finally {
            // Restaurar botón
            btn.innerHTML = originalText;
            btn.disabled = false;
            document.getElementById('dniLoading').style.display = 'none';
            console.log('Consulta finalizada');
        }
    }
    
    // Validar formulario al enviar
    document.getElementById('registroForm').addEventListener('submit', function(event) {
        const nombre = document.getElementById('nombre').value.trim();
        const apellido = document.getElementById('apellido').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const dni = document.getElementById('dni').value.trim();
        
        // Validar que el DNI esté ingresado
        if (!dni) {
            event.preventDefault();
            mostrarErrorDNI('El DNI es obligatorio');
            document.getElementById('dni').focus();
            return;
        }
        
        // Validar formato del DNI
        if (dni.length !== 8 || isNaN(dni)) {
            event.preventDefault();
            mostrarErrorDNI('El DNI debe tener 8 dígitos numéricos');
            document.getElementById('dni').focus();
            return;
        }
        
        // Validar que los campos de nombre estén llenos
        if (!nombre || !apellido) {
            event.preventDefault();
            mostrarErrorDNI('Debes consultar tu DNI para obtener tus datos');
            return;
        }
        
        // Validar contraseñas
        if (password !== confirmPassword) {
            event.preventDefault();
            showAlert('Las contraseñas no coinciden', 'danger');
            document.getElementById('password').focus();
            return;
        }
        
        if (password.length < 6) {
            event.preventDefault();
            showAlert('La contraseña debe tener al menos 6 caracteres', 'danger');
            document.getElementById('password').focus();
            return;
        }
        
        // Mostrar mensaje de procesamiento
        showAlert('Procesando registro...', 'info');
    });
    
    // Permitir buscar DNI con Enter
    document.getElementById('dni').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            consultarDNI();
        }
    });
    
    // Consultar automáticamente cuando se escribe el DNI completo
    document.getElementById('dni').addEventListener('input', function(event) {
        const dni = this.value.trim();
        if (dni.length === 8 && !isNaN(dni)) {
            // Pequeño delay para no consultar demasiado rápido
            setTimeout(() => {
                consultarDNI();
            }, 300);
        } else if (dni.length < 8) {
            // Si cambian el DNI, limpiar datos
            datosDeApi = false;
            document.getElementById('nombre').value = '';
            document.getElementById('apellido').value = '';
            actualizarEstadoCampos();
            actualizarNombreUsuario();
            ocultarDniInfoCard();
            ocultarErrorDNI();
        }
    });
    
    // Auto-focus en campo DNI al cargar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Página cargada');
        document.getElementById('dni').focus();
        actualizarEstadoCampos();
        
        // Configurar Thymeleaf para los mensajes flash
        const successMessage = document.querySelector('.alert-success');
        const errorMessage = document.querySelector('.alert-danger');
        
        if (successMessage || errorMessage) {
            // Auto-eliminar mensajes después de 5 segundos
            setTimeout(() => {
                if (successMessage) successMessage.remove();
                if (errorMessage) errorMessage.remove();
            }, 5000);
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>