<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <title>Catálogo - Bibliosfera</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .list-img {
            width: 50px;
            height: 75px;
            object-fit: contain;
        }
        .list-row {
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            padding-top: 10px;
            padding-bottom: 10px;
        }
        .list-group-item-action:hover {
            background-color: #f8f9fa;
        }
        .admin-button-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        .admin-button {
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .admin-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .stock-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            margin-left: 5px;
        }
        /* Estilos para el modal */
        .modal-img-container {
            max-height: 400px;
            overflow: hidden;
        }
        .modal-img {
            max-height: 380px;
            object-fit: contain;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<header class="border-bottom bg-light py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6 col-12 text-center text-lg-start mb-3 mb-lg-0">
                <h2 class="text-primary display-5 fw-bold opacity-75">
                    <i class="bi bi-book"></i> Catálogo
                </h2>
                <h4>"Explora historias que esperan ser descubiertas."</h4>
            </div>
            <div class="col-lg-6 col-12 text-center">
                <img th:src="@{/img/lib5.jpg}" class="img-fluid rounded shadow" alt="Catálogo" style="max-height: 200px;">
            </div>
        </div>
    </div>
</header>

<!-- Botón flotante de Administración (solo para admin) -->
<div sec:authorize="hasRole('ADMIN')" class="admin-button-container">
    <a th:href="@{/admin/lista-libros}" class="btn btn-warning btn-lg shadow-lg rounded-pill admin-button d-flex align-items-center">
        <i class="bi bi-gear-fill me-2"></i> Administrar Stock
    </a>
</div>

<section class="container mt-4 mb-5">
    <h2 class="text-center my-3">Libros Disponibles</h2>

    <div class="row fw-bold py-2 mb-2 bg-light d-none d-md-flex">
        <div class="col-md-1"></div>
        <div class="col-md-5">Título del Libro</div>
        <div class="col-md-2 text-center">Precio</div>
        <div class="col-md-2 text-center">Stock</div>
        <div class="col-md-2 text-center">Acciones</div>
    </div>

    <div class="list-group list-group-flush">

        <div class="list-row list-group-item list-group-item-action"
             th:each="libro : ${libros}">

            <!-- Imagen -->
            <div class="col-md-1 col-3 text-center">
                <img th:src="@{${libro.imagenUrl}}"
                     class="img-fluid rounded list-img"
                     th:alt="${libro.titulo}"
                     onerror="this.onerror=null; this.src='https://via.placeholder.com/50x75?text=Sin+imagen';">
            </div>

            <!-- Título y detalles -->
            <div class="col-md-5 col-9 d-flex flex-column justify-content-center">
                <strong th:text="${libro.titulo}">Título del Libro</strong>
                <small class="text-muted" th:if="${libro.autor != null}">
                    <span th:text="${libro.autor.nombre}">Autor</span>
                </small>
                <div class="d-md-none mt-1">
                    <span class="text-muted" 
                          th:text="'S/ ' + ${#numbers.formatDecimal(libro.precio, 1, 'COMMA', 2, 'POINT')}"></span>
                    <span th:if="${libro.stock > 0}" 
                          class="badge bg-success stock-badge ms-2"
                          th:text="${libro.stock} + ' disp.'">
                    </span>
                    <span th:unless="${libro.stock > 0}" 
                          class="badge bg-danger stock-badge ms-2">
                        Agotado
                    </span>
                </div>
            </div>

            <!-- Precio (solo desktop) -->
            <div class="col-md-2 d-none d-md-flex align-items-center justify-content-center">
                <strong class="text-success" 
                        th:text="'S/ ' + ${#numbers.formatDecimal(libro.precio, 1, 'COMMA', 2, 'POINT')}">
                    S/ 0.00
                </strong>
            </div>

            <!-- Stock (solo desktop) -->
            <div class="col-md-2 d-none d-md-flex align-items-center justify-content-center">
                <span th:if="${libro.stock > 10}" 
                      class="badge bg-success"
                      th:text="${libro.stock} + ' unidades'">
                </span>
                <span th:if="${libro.stock > 0 && libro.stock <= 10}" 
                      class="badge bg-warning text-dark"
                      th:text="${libro.stock} + ' unidades'">
                </span>
                <span th:unless="${libro.stock > 0}" 
                      class="badge bg-danger"
                      th:text="'Agotado'">
                </span>
            </div>

            <!-- Botones -->
            <div class="col-md-2 col-12 mt-2 mt-md-0 d-grid gap-2 d-md-flex justify-content-md-end">

                <!-- Agregar al carrito (solo si hay stock) -->
                <div th:if="${libro.stock > 0}">
                    <form th:action="@{/carrito/agregar}" method="post" class="d-grid d-md-inline-block">
                        <input type="hidden" name="idLibro" th:value="${libro.idLibro}"/>
                        <input type="hidden" name="cantidad" value="1"/>
                        <button type="submit" class="btn btn-success btn-sm me-md-2">
                            <i class="bi bi-cart-plus"></i> <span class="d-none d-md-inline">Añadir</span>
                        </button>
                    </form>
                </div>
                <div th:unless="${libro.stock > 0}" class="d-grid d-md-inline-block">
                    <button class="btn btn-secondary btn-sm me-md-2" disabled>
                        <i class="bi bi-cart-x"></i> <span class="d-none d-md-inline">Agotado</span>
                    </button>
                </div>

                <!-- Ver más -->
                <button class="btn btn-primary btn-sm ver-mas"
                        th:data-id="${libro.idLibro}"
                        th:data-title="${libro.titulo}"
                        th:data-author="${libro.autor != null ? libro.autor.nombre : 'No especificado'}"
                        th:data-categoria="${libro.categoria != null ? libro.categoria.nombre : 'No categoría'}"
                        th:data-editorial="${libro.editorial != null ? libro.editorial.nombre : 'Sin editorial'}"
                        th:data-desc="${libro.descripcion}"
                        th:data-price="'S/ ' + ${#numbers.formatDecimal(libro.precio, 1, 'COMMA', 2, 'POINT')}"
                        th:data-stock="${libro.stock}"
                        th:data-fecha="${libro.fechaPublicacion != null ? #temporals.format(libro.fechaPublicacion, 'dd/MM/yyyy') : 'No especificada'}"
                        th:data-img="@{${libro.imagenUrl}}"
                        data-bs-toggle="modal"
                        data-bs-target="#libroModal">
                    <i class="bi bi-eye"></i> <span class="d-none d-md-inline">Ver</span>
                </button>

            </div>
        </div>
    </div>

    <!-- Mensaje si no hay libros -->
    <div th:if="${libros.isEmpty()}" class="text-center py-5">
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No hay libros disponibles en este momento.
        </div>
    </div>

    <!-- MODAL DE DETALLES -->
    <div class="modal fade" id="libroModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center modal-img-container">
                            <img id="modalImg" src="" class="img-fluid rounded shadow mb-3 modal-img"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/300x400?text=Sin+imagen';">
                        </div>
                        <div class="col-md-8">
                            <div class="row mb-2">
                                <div class="col-6">
                                    <p><strong><i class="bi bi-person"></i> Autor:</strong> <span id="modalAuthor"></span></p>
                                </div>
                                <div class="col-6">
                                    <p><strong><i class="bi bi-tag"></i> Categoría:</strong> <span id="modalCategory"></span></p>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <p><strong><i class="bi bi-building"></i> Editorial:</strong> <span id="modalEditorial"></span></p>
                                </div>
                                <div class="col-6">
                                    <p><strong><i class="bi bi-calendar"></i> Publicación:</strong> <span id="modalFecha"></span></p>
                                </div>
                            </div>
                            <p><strong><i class="bi bi-card-text"></i> Descripción:</strong></p>
                            <p id="modalDesc" class="text-muted mb-3"></p>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong><i class="bi bi-cash"></i> Precio:</strong> 
                                        <span id="modalPrice" class="fw-bold text-success"></span>
                                    </p>
                                </div>
                                <div class="col-6">
                                    <p><strong><i class="bi bi-box"></i> Disponibilidad:</strong> 
                                        <span id="modalStock" class="fw-bold"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CORRECCIÓN: Eliminar la línea 242 problemática -->
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <div id="modalAddToCart">
                        <!-- El formulario se agregará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const botones = document.querySelectorAll(".ver-mas");
        const modalAddToCart = document.getElementById("modalAddToCart");

        botones.forEach(boton => {
            boton.addEventListener("click", () => {
                // Obtener datos del botón
                const titulo = boton.dataset.title;
                const autor = boton.dataset.author;
                const categoria = boton.dataset.categoria;
                const editorial = boton.dataset.editorial;
                const desc = boton.dataset.desc;
                const precio = boton.dataset.price;
                const stock = boton.dataset.stock;
                const fecha = boton.dataset.fecha;
                const img = boton.dataset.img;
                const libroId = boton.dataset.id; // Obtener ID del data attribute

                console.log("Libro ID:", libroId); // Para debugging

                // Actualizar contenido del modal
                document.getElementById("modalTitle").textContent = titulo;
                document.getElementById("modalAuthor").textContent = autor;
                document.getElementById("modalCategory").textContent = categoria;
                document.getElementById("modalEditorial").textContent = editorial;
                document.getElementById("modalDesc").textContent = desc || "Sin descripción disponible";
                document.getElementById("modalPrice").textContent = precio;
                document.getElementById("modalFecha").textContent = fecha;
                
                // Manejar imagen
                const imgElement = document.getElementById("modalImg");
                if (img && img.trim() !== '') {
                    imgElement.src = img;
                } else {
                    imgElement.src = 'https://via.placeholder.com/300x400?text=Sin+imagen';
                }
                
                // Manejar stock
                const stockElement = document.getElementById("modalStock");
                const stockNum = parseInt(stock);
                
                if (stockNum > 10) {
                    stockElement.textContent = `${stock} unidades disponibles`;
                    stockElement.className = 'fw-bold text-success';
                } else if (stockNum > 0) {
                    stockElement.textContent = `Últimas ${stock} unidades`;
                    stockElement.className = 'fw-bold text-warning';
                } else {
                    stockElement.textContent = 'Producto agotado';
                    stockElement.className = 'fw-bold text-danger';
                }
                
                // Manejar botón de añadir al carrito
                if (modalAddToCart) {
                    modalAddToCart.innerHTML = '';
                    
                    if (stockNum > 0 && libroId) {
                        const form = document.createElement('form');
                        form.action = '/carrito/agregar';
                        form.method = 'post';
                        form.className = 'd-inline';
                        
                        // Agregar CSRF token si estás usando Spring Security
                        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
                        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
                        
                        if (csrfToken && csrfHeader) {
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = '_csrf';
                            csrfInput.value = csrfToken;
                            form.appendChild(csrfInput);
                        }
                        
                        const inputId = document.createElement('input');
                        inputId.type = 'hidden';
                        inputId.name = 'idLibro';
                        inputId.value = libroId;
                        
                        const inputCantidad = document.createElement('input');
                        inputCantidad.type = 'hidden';
                        inputCantidad.name = 'cantidad';
                        inputCantidad.value = '1';
                        
                        const button = document.createElement('button');
                        button.type = 'submit';
                        button.className = 'btn btn-success btn-lg';
                        button.innerHTML = '<i class="bi bi-cart-plus me-2"></i>Añadir al carrito';
                        
                        // Añadir evento para mostrar confirmación
                        button.addEventListener('click', function(e) {
                            console.log("Añadiendo libro ID:", libroId, "al carrito");
                            // Opcional: Mostrar mensaje de confirmación
                            // alert(`"${titulo}" ha sido añadido al carrito`);
                        });
                        
                        form.appendChild(inputId);
                        form.appendChild(inputCantidad);
                        form.appendChild(button);
                        modalAddToCart.appendChild(form);
                    } else {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'btn btn-secondary btn-lg';
                        button.disabled = true;
                        button.innerHTML = '<i class="bi bi-cart-x me-2"></i>Producto agotado';
                        modalAddToCart.appendChild(button);
                    }
                }
            });
        });
        
        // Limpiar modal cuando se cierre
        const modal = document.getElementById('libroModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function () {
                document.getElementById("modalTitle").textContent = '';
                document.getElementById("modalAuthor").textContent = '';
                document.getElementById("modalCategory").textContent = '';
                document.getElementById("modalEditorial").textContent = '';
                document.getElementById("modalDesc").textContent = '';
                document.getElementById("modalPrice").textContent = '';
                document.getElementById("modalFecha").textContent = '';
                document.getElementById("modalImg").src = '';
                document.getElementById("modalStock").textContent = '';
                
                if (modalAddToCart) {
                    modalAddToCart.innerHTML = '';
                }
            });
        }
    });
</script>

<!-- Notificación flotante para agregar al carrito -->
<div id="cartNotification" class="position-fixed top-0 end-0 m-4 p-3 bg-success text-white rounded shadow-lg" 
     style="z-index: 1050; display: none; transition: all 0.3s ease;">
    <i class="bi bi-check-circle-fill me-2"></i>
    <span id="notificationMessage"></span>
</div>

<script>
    // Función para mostrar notificación
    function showNotification(message) {
        const notification = document.getElementById('cartNotification');
        const messageSpan = document.getElementById('notificationMessage');
        
        messageSpan.textContent = message;
        notification.style.display = 'block';
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }
    
    // Escuchar eventos de formularios de carrito
    document.addEventListener('submit', function(e) {
        if (e.target.action && e.target.action.includes('/carrito/agregar')) {
            e.preventDefault(); // Prevenir envío inmediato para mostrar notificación
            
            const form = e.target;
            const libroId = form.querySelector('input[name="idLibro"]').value;
            const libroTitulo = form.closest('.list-row')?.querySelector('strong')?.textContent || 'el libro';
            
            // Mostrar notificación
            showNotification(`¡${libroTitulo} añadido al carrito!`);
            
            // Enviar formulario después de 1 segundo
            setTimeout(() => {
                form.submit();
            }, 1000);
        }
    });
</script>

<div th:replace="~{fragments/footer :: footer}"></div>

</body>
</html>