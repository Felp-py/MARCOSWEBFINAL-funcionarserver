<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas de Compras - Bibliosfera</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Chart.js desde CDN directo -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .stat-card { 
            transition: transform 0.3s ease; 
            height: 100%;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .chart-container { 
            height: 300px; 
            margin-bottom: 20px; 
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .no-data {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #6c757d;
        }
    </style>
</head>
<body>

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="bg-gradient-primary text-white p-4 rounded shadow-sm" 
                     style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="bi bi-bar-chart-line me-2"></i>Estadísticas de Compras
                    </h1>
                    <p class="mb-0" th:if="${totalCompras > 0}" th:text="'Análisis de ' + ${totalCompras} + ' compras realizadas'">
                        Análisis de compras realizadas
                    </p>
                    <p class="mb-0" th:unless="${totalCompras > 0}">
                        No hay compras registradas todavía
                    </p>
                </div>
            </div>
        </div>

        <!-- Resumen Estadístico -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-primary">
                    <div class="card-body text-center">
                        <i class="bi bi-cart-check stat-icon text-primary"></i>
                        <h2 class="display-6 fw-bold" th:text="${totalCompras}">0</h2>
                        <p class="text-muted mb-0">Compras Realizadas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-success">
                    <div class="card-body text-center">
                        <i class="bi bi-book stat-icon text-success"></i>
                        <h2 class="display-6 fw-bold" th:text="${totalLibrosComprados}">0</h2>
                        <p class="text-muted mb-0">Libros Vendidos</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-cash-coin stat-icon text-warning"></i>
                        <h2 class="display-6 fw-bold" 
                            th:text="${'S/ ' + #numbers.formatDecimal(gastoTotal, 1, 'COMMA', 2, 'POINT')}">
                            S/ 0.00
                        </h2>
                        <p class="text-muted mb-0">Ingreso Total</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-info">
                    <div class="card-body text-center">
                        <i class="bi bi-star stat-icon text-info"></i>
                        <h2 class="display-6 fw-bold" 
                            th:text="${'S/ ' + #numbers.formatDecimal(promedioCompra, 1, 'COMMA', 2, 'POINT')}">
                            S/ 0.00
                        </h2>
                        <p class="text-muted mb-0">Ticket Promedio</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos con datos reales -->
        <div class="row mb-5">
            <!-- Gráfico de barras: Libros más vendidos -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-trophy me-2"></i>Libros Más Vendidos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="barChart"></canvas>
                        </div>
                        <div th:if="${librosMasVendidos.empty}" class="no-data">
                            <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
                            <p class="mt-3">No hay datos de ventas disponibles</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gráfico de pastel: Distribución por categorías -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Ventas por Categoría
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                        <div th:if="${distribucionCategorias.empty}" class="no-data">
                            <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
                            <p class="mt-3">No hay datos de categorías disponibles</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tablas con datos reales -->
        <div th:unless="${librosMasVendidos.empty}" class="row mb-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ol me-2"></i>Top Libros Más Vendidos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Libro</th>
                                        <th class="text-end">Unidades Vendidas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="libro, stat : ${librosMasVendidos}">
                                        <td th:text="${stat.index + 1}">1</td>
                                        <td th:text="${libro[0]}">Título del libro</td>
                                        <td class="text-end">
                                            <span class="badge bg-primary" th:text="${libro[1]}">0</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Script para crear gráficos con datos reales -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log("=== INICIANDO GRÁFICOS CON DATOS REALES ===");
                
                // Obtener datos de Thymeleaf
                const librosMasVendidos = /*[[${librosMasVendidos}]]*/ [];
                const distribucionCategorias = /*[[${distribucionCategorias}]]*/ [];
                
                console.log("Datos recibidos:", {
                    librosMasVendidos: librosMasVendidos,
                    distribucionCategorias: distribucionCategorias
                });
                
                // 1. Gráfico de barras: Libros más vendidos
                if (librosMasVendidos.length > 0 && document.getElementById('barChart')) {
                    console.log("Creando gráfico de barras con datos reales...");
                    
                    // Preparar datos
                    const labelsLibros = librosMasVendidos.map(item => {
                        const titulo = item[0];
                        // Acortar títulos largos para mejor visualización
                        return titulo.length > 25 ? titulo.substring(0, 25) + '...' : titulo;
                    });
                    
                    const dataLibros = librosMasVendidos.map(item => {
                        const valor = item[1];
                        // Convertir diferentes tipos a número
                        if (typeof valor === 'number') return valor;
                        if (typeof valor === 'string') return parseInt(valor) || 0;
                        if (valor instanceof Number) return valor.valueOf();
                        return 0;
                    });
                    
                    console.log("Labels libros:", labelsLibros);
                    console.log("Data libros:", dataLibros);
                    
                    try {
                        new Chart(document.getElementById('barChart').getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: labelsLibros,
                                datasets: [{
                                    label: 'Unidades Vendidas',
                                    data: dataLibros,
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                        console.log("Gráfico de barras creado exitosamente");
                    } catch (error) {
                        console.error("Error creando gráfico de barras:", error);
                        document.getElementById('barChart').parentElement.innerHTML = 
                            '<div class="alert alert-warning">Error al crear gráfico: ' + error.message + '</div>';
                    }
                }
                
                // 2. Gráfico de pastel: Distribución por categorías
                if (distribucionCategorias.length > 0 && document.getElementById('pieChart')) {
                    console.log("Creando gráfico de pastel con datos reales...");
                    
                    // Preparar datos
                    const labelsCategorias = distribucionCategorias.map(item => item[0]);
                    const dataCategorias = distribucionCategorias.map(item => {
                        const valor = item[1];
                        if (typeof valor === 'number') return valor;
                        if (typeof valor === 'string') return parseInt(valor) || 0;
                        if (valor instanceof Number) return valor.valueOf();
                        return 0;
                    });
                    
                    console.log("Labels categorías:", labelsCategorias);
                    console.log("Data categorías:", dataCategorias);
                    
                    // Colores para el gráfico de pastel
                    const pieColors = [
                        'rgba(255, 99, 132, 0.7)',   // Rojo
                        'rgba(54, 162, 235, 0.7)',   // Azul
                        'rgba(255, 206, 86, 0.7)',   // Amarillo
                        'rgba(75, 192, 192, 0.7)',   // Verde agua
                        'rgba(153, 102, 255, 0.7)',  // Morado
                        'rgba(255, 159, 64, 0.7)',   // Naranja
                        'rgba(201, 203, 207, 0.7)',  // Gris
                        'rgba(0, 204, 102, 0.7)',    // Verde
                        'rgba(204, 0, 102, 0.7)',    // Rosa
                        'rgba(102, 0, 204, 0.7)'     // Violeta
                    ];
                    
                    try {
                        new Chart(document.getElementById('pieChart').getContext('2d'), {
                            type: 'pie',
                            data: {
                                labels: labelsCategorias,
                                datasets: [{
                                    data: dataCategorias,
                                    backgroundColor: pieColors.slice(0, labelsCategorias.length),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'right'
                                    }
                                }
                            }
                        });
                        console.log("Gráfico de pastel creado exitosamente");
                    } catch (error) {
                        console.error("Error creando gráfico de pastel:", error);
                        document.getElementById('pieChart').parentElement.innerHTML = 
                            '<div class="alert alert-warning">Error al crear gráfico: ' + error.message + '</div>';
                    }
                }
                
                // Si no hay datos, mostrar mensajes
                if (librosMasVendidos.length === 0 && distribucionCategorias.length === 0) {
                    console.log("No hay datos para mostrar en gráficos");
                    
                    // Ocultar sección de gráficos si no hay datos
                    const chartSection = document.querySelector('.row.mb-5');
                    if (chartSection) {
                        chartSection.innerHTML = `
                            <div class="col-12">
                                <div class="card shadow-sm">
                                    <div class="card-body text-center py-5">
                                        <i class="bi bi-database text-muted" style="font-size: 4rem;"></i>
                                        <h4 class="mt-3 text-muted">No hay datos de ventas disponibles</h4>
                                        <p class="text-muted">Las estadísticas se mostrarán cuando se realicen compras en el sistema.</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                console.log("=== GRÁFICOS FINALIZADOS ===");
            });
        </script>

    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>