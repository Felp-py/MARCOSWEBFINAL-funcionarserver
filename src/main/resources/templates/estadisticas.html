<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas de Compras - Bibliosfera</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Cargar Chart.js localmente como fallback -->
    <script>
        // Verificar si Chart ya está cargado
        if (typeof Chart === 'undefined') {
            // Cargar desde CDN alternativo
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
            script.integrity = 'sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==';
            script.crossOrigin = 'anonymous';
            script.referrerpolicy = 'no-referrer';
            document.head.appendChild(script);
            
            // Esperar a que cargue
            script.onload = function() {
                console.log('Chart.js cargado desde CDN alternativo');
                initCharts();
            };
        } else {
            console.log('Chart.js ya está cargado');
            // Inicializar inmediatamente
            document.addEventListener('DOMContentLoaded', initCharts);
        }
        
        // Esperar a que el DOM esté listo
        function initCharts() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createCharts);
            } else {
                createCharts();
            }
        }
    </script>
    
    <style>
        .stat-card { transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .chart-container { height: 300px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="bg-gradient-primary text-white p-4 rounded shadow-sm" 
                     style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="bi bi-bar-chart-line me-2"></i>Estadísticas de Compras
                    </h1>
                </div>
            </div>
        </div>

        <!-- Resumen Estadístico -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-primary">
                    <div class="card-body text-center">
                        <i class="bi bi-cart-check stat-icon text-primary"></i>
                        <h2 class="display-6 fw-bold" th:text="${totalCompras != null ? totalCompras : 0}">0</h2>
                        <p class="text-muted mb-0">Compras Realizadas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-success">
                    <div class="card-body text-center">
                        <i class="bi bi-book stat-icon text-success"></i>
                        <h2 class="display-6 fw-bold" th:text="${totalLibrosComprados != null ? totalLibrosComprados : 0}">0</h2>
                        <p class="text-muted mb-0">Libros Comprados</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-warning">
                    <div class="card-body text-center">
                        <i class="bi bi-cash-coin stat-icon text-warning"></i>
                        <h2 class="display-6 fw-bold" 
                            th:text="${gastoTotal != null ? 'S/ ' + #numbers.formatDecimal(gastoTotal, 1, 'COMMA', 2, 'POINT') : 'S/ 0.00'}">
                            S/ 0.00
                        </h2>
                        <p class="text-muted mb-0">Gasto Total</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-info">
                    <div class="card-body text-center">
                        <i class="bi bi-star stat-icon text-info"></i>
                        <h2 class="display-6 fw-bold" 
                            th:text="${promedioCompra != null ? 'S/ ' + #numbers.formatDecimal(promedioCompra, 1, 'COMMA', 2, 'POINT') : 'S/ 0.00'}">
                            S/ 0.00
                        </h2>
                        <p class="text-muted mb-0">Promedio por Compra</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row mb-5">
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Libros por Cantidad</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Distribución</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Script para crear gráficos -->
        <script>
            function createCharts() {
                console.log("Creando gráficos...");
                console.log("Chart disponible?", typeof Chart);
                
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js no está disponible');
                    showErrorMessages();
                    return;
                }
                
                try {
                    // Gráfico de barras
                    const barCtx = document.getElementById('barChart');
                    if (barCtx) {
                        new Chart(barCtx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels: ['Libro A', 'Libro B', 'Libro C', 'Libro D', 'Libro E'],
                                datasets: [{
                                    label: 'Cantidad',
                                    data: [12, 19, 3, 5, 2],
                                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                        console.log("Gráfico de barras creado");
                    }
                    
                    // Gráfico de pastel
                    const pieCtx = document.getElementById('pieChart');
                    if (pieCtx) {
                        new Chart(pieCtx.getContext('2d'), {
                            type: 'pie',
                            data: {
                                labels: ['Ficción', 'Ciencia', 'Historia', 'Fantasia'],
                                datasets: [{
                                    data: [30, 20, 15, 35],
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(54, 162, 235, 0.7)',
                                        'rgba(255, 206, 86, 0.7)',
                                        'rgba(75, 192, 192, 0.7)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                        console.log("Gráfico de pastel creado");
                    }
                    
                } catch (error) {
                    console.error('Error creando gráficos:', error);
                    showErrorMessages();
                }
            }
            
            function showErrorMessages() {
                const containers = document.querySelectorAll('.chart-container');
                containers.forEach(container => {
                    container.innerHTML = '<div class="alert alert-warning">Error al cargar gráficos. Recarga la página.</div>';
                });
            }
            
            // Inicializar cuando Chart.js esté listo
            if (typeof Chart !== 'undefined' && Chart.Chart) {
                document.addEventListener('DOMContentLoaded', createCharts);
            }
            // Si Chart.js se carga después, ya tenemos el event listener en el <head>
        </script>

    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>